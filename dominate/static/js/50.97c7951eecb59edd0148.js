webpackJsonp([50],{"6JdH":function(e,t){},Tfte:function(e,t,r){"use strict";function i(e){r("6JdH")}Object.defineProperty(t,"__esModule",{value:!0});var o=r("3cXf"),a=r.n(o),l={data:function(){var e=this,t=function(t,r,i){!r||e.$http.trim(r).length<1?(e.volumeForm.volumeName="",i(new Error("卷名不能为空"))):e.$ajax("/books-getCheckVolume",{volumeName:r,bookid:e.ruleForm.bookId},function(e){200===e.returnCode?i():i(new Error(e.msg))})},r=function(t,r,i){r=e.$http.trim(r),!r||e.$http.trim(r).length<1?(e.ruleForm.chapterTitle="",i(new Error("请输入章节名称"))):e.$http.trim(r)===e.oldChapterName?i():e.$ajax("/chapter-checkName",{chapterName:r,bookId:e.ruleForm.bookId},function(t){200===t.returnCode?i():(e.$message("章节名重复，请重新填写！"),i(new Error("章节名重复，请重新填写！")))})};return{pickerOptions:{disabledDate:function(e){return e.getTime()<Date.now()-864e5}},isLoading:void 0,isRload:!0,iframeShow:"hidden",dialogSize:"tiny",original:{},volumeList:[],isAutoPublish:!1,labelWidth:"136px",dialogFormVisible:!1,editContent:"",initial:[],cidList:[],volumeForm:{volumeName:""},oldChapterName:"",ruleForm:{bookTitle:"",chapterTitle:"",volumeId:null,releaseTime:null,chapterContent:"",whetherPublic:0,chapterLength:0,chapterIsvip:0,authorWords:"",issue:!1,update:!1},rule:{volumeName:[{required:!0,validator:t,trigger:"blur"}]},rules:{chapterTitle:[{required:!0,validator:r,trigger:"blur"}],volumeId:[{required:!0,type:"number",message:"请选择分卷",trigger:"change"}],bookTitle:[{required:!0,message:"请输入书籍名称",trigger:"blur"}],chapterContent:[{required:!0,message:"请添加章节内容",trigger:"blur"}],releaseTime:[{required:!0,type:"date",message:"请选取时间",trigger:"blur"}]}}},methods:{submitForm:function(e){var t=this;this.isLoading=this.$loading({lock:!0,text:"Loading",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),this.$refs.editChapterForm.validate(function(r){if(!r)return t.$nextTick(function(){t.isLoading.close()}),t.$message({message:"请完善信息后提交！",type:"warning"}),!1;"draft"===e&&(t.ruleForm.whetherPublic=1),t.editChapter()})},editChapter:function(){var e=this;if(this.ruleForm.chapterLength>2e4)return this.isLoading.close(),this.$confirm("文章内容超出字数长度限制，请保证字数长度在20000以内！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),!1;var t=JSON.parse(a()(this.ruleForm)),r=function(){e.$ajax("/admin/updateChapterInfo",t,function(r){e.isLoading.close(),200===r.returnCode&&e.$confirm(t.whetherPublic?1===t.whetherPublic?"保存草稿成功":"发布成功":"编辑成功","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){e.getChapterInfo()}).catch(function(){e.getChapterInfo()})})};if(1===this.ruleForm.whetherPublic)t.chapterContent=this.$http.trim(t.chapterContent).replace(/\n+\s+/g,"<H><LG>")+"<H><LG>",t.whetherPublic=t.issue?2:1,this.$ajax("/sys-getNetWorkDateTime","",function(i){200===i.returnCode?(t.releaseTime=e.$formTime(i.data.beijing,"long"),r()):e.isLoading.close()},"get");else{var i=document.getElementById("content_edit_sole").childNodes;t.chapterContent="";for(var o=0,l=i.length;o<l;o++)this.$http.trim(i[o].innerText).length>0&&(t.chapterContent+=this.$http.trim(i[o].innerText)+i[o].getAttribute("uuid"));t.releaseTime=this.$formTime(t.releaseTime,"long"),r()}},addNewVolume:function(e){var t=this;this.$refs[e].validate(function(e){e?t.$ajax("/books-addvolume",{volumeName:t.volumeForm.volumeName,bookName:t.ruleForm.bookTitle,bookid:t.$route.params.bid},function(e){200===e.returnCode&&(t.dialogFormVisible=!1,t.$message("添加成功"),t.getChapterInfo())}):t.$message({message:"请填写卷名！",type:"warning"})})},getChapterInfo:function(){var e=this,t=/<LG>[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}<\/?LG ?\/?>/,r=/<LG>[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}<\/?LG ?\/?>/g;this.$ajax("/sys-getNetWorkDateTime","",function(i){if(200===i.returnCode){e.$ajax("/admin/getChapterInfoShow",{chapterid:e.$route.params.cid},function(i){if(e.update=!1,200===i.returnCode){if(e.isRload=!1,e.original=JSON.parse(a()(i.data)),e.initial=[],delete i.data.createChapterTime,i.data.releaseTime=new Date(i.data.releaseTime),e.oldChapterName=i.data.chapterTitle,1===i.data.whetherPublic)i.data.chapterContent=i.data.chapterContent.replace(/<H><LG>/g,"\n\n  ");else{var o=i.data.chapterContent.match(r),l=i.data.chapterContent.split(t);i.data.chapterContent=i.data.chapterContent.replace(r,"\n"),o.forEach(function(t,r){e.initial.push({uuid:t,content:e.$http.trim(l[r])})})}e.ruleForm=i.data,e.getVolume(),setTimeout(function(){e.isRload=!0},100)}});var o=0;setInterval(function(){o++,e.$set(e.original,"nowTime",i.data.beijing+1e3*o)},1e3)}},"get")},getVolume:function(){var e=this;this.$ajax("/books-getvolume",{bookId:this.ruleForm.bookId},function(t){200===t.returnCode&&(e.volumeList=t.data,e.update=!0)})},checkChapterName:function(e){e.target.value.length},editChange:function(e){var t=document.getElementById("content_edit_sole"),r=t.childNodes;if(this.ruleForm.chapterContent=this.$http.trim(t.innerText),r.length>0)for(var i=0,o=r.length;i<o;i++)r[i].style=null,this.$http.trim(r[i].innerText).length?(r[i].getAttribute("uuid")?i>0&&r[i].getAttribute("uuid").length>7&&r[i-1].getAttribute("uuid")===r[i].getAttribute("uuid")&&r[i].setAttribute("uuid","<H><LG>"):r[i].setAttribute("uuid","<H><LG>"),r[i].childNodes.length>1&&(r[i].innerHTML=r[i].innerText)):r[i].setAttribute("uuid","<H><LG>");if(e.target.innerHTML.length<1){var a=document.createElement("p");a.innerHTML="<br>",a.style=null,t.insertBefore(a,t.childNodes[0])}},changeVolume:function(e){var t=this;this.volumeList.length&&e&&this.update&&this.$confirm("确认调整本章分卷?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){t.$ajax("/chapterToVolume",{chapterid:t.ruleForm.id,volumeid:e,bookid:t.ruleForm.bookId},function(e){200===e.returnCode&&t.$message({type:"success",message:"调整成功!"})})}).catch(function(){t.$message({message:"已取消调整"}),t.getChapterInfo()})},preventCopy:function(e){if(17===e.keyCode&&72===e.keyCode)return e.returnValue=!1,!1}},created:function(){var e=document.body.clientWidth;this.dialogSize=e<1024?"small":"tiny",this.getChapterInfo()},watch:{"ruleForm.chapterContent":function(e){1===this.ruleForm.whetherPublic&&(this.ruleForm.chapterContent=e.replace(/^\s*\n+\s*/,"").replace(/\s*\n+\s*/g,"\n\n　　"))},editContent:function(e){var t=document.getElementById("content_edit_sole"),r=t.childNodes;if(this.ruleForm.chapterContent=this.$http.trim(t.innerText),r.length>0&&this.isUpDate)for(var i=0,o=r.length;i<o;i++)r[i].style=null,this.$http.trim(r[i].innerText).length?(r[i].innerHTML=this.$http.trim(r[i].innerHTML),r[i].childNodes.length>1&&(r[i].innerHTML=r[i].innerText)):r[i].setAttribute("uuid","<H><LG>")},"ruleForm.authorWords":function(e){this.$http.trim(e).length>100&&(e=e.substr(0,100)),this.ruleForm.authorWords=e.replace(/^\s*\n+\s*/,"").replace(/\s*\n+\s*/g,"\n\n　　")}},computed:{length:function(){var e=0,t=this.ruleForm.chapterContent;try{t=t.replace(/(\r\n+|\s+| )+/g,"龘"),t=t.replace(/龘+/g,""),e+=t.length}catch(e){console.log(e)}return this.ruleForm.chapterLength=e,e>2e4&&this.$message({message:"字数长度不可超过20000！",type:"error"}),e},isChange:function(){var e=!1;return this.original&&(e=!!this.original.whetherPublic||!(this.original.releaseTime&&this.original.releaseTime>this.original.nowTime)),e},authority:function(){return this.$store.state.userInfo.adminRolemenuanduserrole?this.$store.state.userInfo.adminRolemenuanduserrole:{}}},mounted:function(){var e=this;window.onresize=function(){var t=document.body.clientWidth;e.dialogSize=t<1020?"small":"tiny"}}},n=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"wrapper"},[r("el-breadcrumb",{staticClass:"mbt20",attrs:{"separator-class":"el-icon-arrow-right"}},[r("el-breadcrumb-item",[e._v("书籍管理")]),e._v(" "),r("el-breadcrumb-item",{attrs:{to:"/book/list"}},[e._v("书籍列表")]),e._v(" "),r("el-breadcrumb-item",{attrs:{to:"/book_chapter_list/"+e.original.bookId}},[e._v("章节列表")]),e._v(" "),r("el-breadcrumb-item",[e._v("编辑章节")])],1),e._v(" "),r("el-alert",{staticClass:"mbt20",attrs:{title:"操作说明",type:"info","show-icon":""}},[r("div",{attrs:{slot:""},slot:"default"},[e._v("\n      文字说明文字说明文字说明文字说明文字说明文字说明\n    ")])]),e._v(" "),r("div",{staticClass:"form-wrapper"},[r("el-form",{ref:"editChapterForm",staticClass:"chapter-ruleForm",attrs:{model:e.ruleForm,rules:e.rules,"label-width":e.labelWidth,labelPosition:"left"}},[r("el-form-item",{attrs:{label:"书籍名称",prop:"bookTitle"}},[r("el-input",{staticStyle:{width:"260px"},attrs:{readonly:""},model:{value:e.ruleForm.bookTitle,callback:function(t){e.$set(e.ruleForm,"bookTitle",t)},expression:"ruleForm.bookTitle"}})],1),e._v(" "),r("el-form-item",{attrs:{label:"分卷名称",prop:"volumeId"}},[r("el-select",{staticStyle:{width:"260px"},attrs:{disabled:!e.authority.updates,placeholder:"请选择分卷"},on:{change:e.changeVolume},model:{value:e.ruleForm.volumeId,callback:function(t){e.$set(e.ruleForm,"volumeId",t)},expression:"ruleForm.volumeId"}},[[e._l(e.volumeList,function(e){return r("el-option",{key:e.id,attrs:{label:e.volumeName,value:e.id}})}),e._v(" "),r("el-option",{attrs:{label:"",value:""},nativeOn:{click:function(t){e.dialogFormVisible=!0}}},[e._v("+新增分卷")])]],2)],1),e._v(" "),r("el-form-item",{attrs:{label:"章节名称",prop:"chapterTitle"}},[r("el-input",{staticStyle:{width:"260px"},model:{value:e.ruleForm.chapterTitle,callback:function(t){e.$set(e.ruleForm,"chapterTitle",t)},expression:"ruleForm.chapterTitle"}})],1),e._v(" "),r("el-form-item",{staticClass:"contentBox",attrs:{label:"章节内容",prop:"chapterContent"}},[r("el-input",{directives:[{name:"show",rawName:"v-show",value:1==e.ruleForm.whetherPublic,expression:"ruleForm.whetherPublic==1"}],staticClass:"context",attrs:{type:"textarea"},model:{value:e.ruleForm.chapterContent,callback:function(t){e.$set(e.ruleForm,"chapterContent",t)},expression:"ruleForm.chapterContent"}}),e._v(" "),r("div",{directives:[{name:"show",rawName:"v-show",value:1!=e.ruleForm.whetherPublic,expression:"ruleForm.whetherPublic!=1"}],staticClass:"iframe-wrap"},[e.isRload?r("div",{attrs:{id:"content_edit_sole",unselectable:"on",contenteditable:!0},on:{input:e.editChange},nativeOn:{keydown:function(t){return e.preventCopy(t)}},model:{value:e.editContent,callback:function(t){e.editContent=t},expression:"editContent"}},[e._l(e.initial,function(t,i){return[r("p",{attrs:{uuid:t.uuid}},[e._v("\n                "+e._s(t.content)+"\n              ")])]})],2):e._e()]),e._v(" "),r("el-input",{staticClass:"authorSay-wrap",attrs:{type:"textarea",placeholder:"作者的话（不超过100字）"},model:{value:e.ruleForm.authorWords,callback:function(t){e.$set(e.ruleForm,"authorWords",t)},expression:"ruleForm.authorWords"}}),e._v(" "),r("span",{staticClass:"words"},[e._v("共 "+e._s(e.length)+" 字")])],1),e._v(" "),r("el-form-item",{staticStyle:{"margin-top":"50px"},attrs:{"label-width":e.labelWidth,label:"发布时间",prop:"releaseTime"}},[r("el-col",{attrs:{span:8}},[r("el-date-picker",{attrs:{type:"datetime",placeholder:"选择时间","picker-options":e.pickerOptions},model:{value:e.ruleForm.releaseTime,callback:function(t){e.$set(e.ruleForm,"releaseTime",t)},expression:"ruleForm.releaseTime"}})],1),e._v(" "),r("el-col",{attrs:{span:12}},[e.ruleForm.whetherPublic?r("el-form-item",{attrs:{"label-width":"0px",prop:"issue"}},[r("el-checkbox",{model:{value:e.ruleForm.issue,callback:function(t){e.$set(e.ruleForm,"issue",t)},expression:"ruleForm.issue"}},[e._v("立即发布")])],1):e._e()],1)],1),e._v(" "),r("el-form-item",{attrs:{"label-width":e.labelWidth,label:"是否VIP"}},[r("el-radio",{staticClass:"radio",attrs:{label:0},model:{value:e.ruleForm.chapterIsvip,callback:function(t){e.$set(e.ruleForm,"chapterIsvip",t)},expression:"ruleForm.chapterIsvip"}},[e._v("普通")]),e._v(" "),r("el-radio",{staticClass:"radio",attrs:{label:1},model:{value:e.ruleForm.chapterIsvip,callback:function(t){e.$set(e.ruleForm,"chapterIsvip",t)},expression:"ruleForm.chapterIsvip"}},[e._v("VIP")])],1),e._v(" "),e.authority.updates?r("el-form-item",{staticClass:"tc",staticStyle:{width:"820px"},attrs:{"label-width":e.labelWidth}},[r("el-button",{attrs:{type:"primary"},on:{click:function(t){e.submitForm("create")}}},[e._v("确认编辑")])],1):e._e()],1)],1),e._v(" "),r("el-dialog",{staticClass:"alertDialog",attrs:{top:"45%",title:"新增分卷",visible:e.dialogFormVisible},on:{open:function(t){e.volumeForm.volumeName=""},"update:visible":function(t){e.dialogFormVisible=t}}},[r("el-form",{ref:"volumeForm",attrs:{model:e.volumeForm,rules:e.rule,"label-position":"left"}},[r("el-form-item",{attrs:{label:"分卷名称",prop:"volumeName","label-width":"80px"}},[r("el-input",{attrs:{"auto-complete":"off"},model:{value:e.volumeForm.volumeName,callback:function(t){e.$set(e.volumeForm,"volumeName",t)},expression:"volumeForm.volumeName"}})],1)],1),e._v(" "),r("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[r("el-button",{on:{click:function(t){e.dialogFormVisible=!1}}},[e._v("取 消")]),e._v(" "),r("el-button",{attrs:{type:"primary"},on:{click:function(t){e.addNewVolume("volumeForm")}}},[e._v("确 定")])],1)],1)],1)},s=[],u=r("18Nq"),c=i,m=Object(u.a)(l,n,s,!1,c,null,null);t.default=m.exports}});
//# sourceMappingURL=50.97c7951eecb59edd0148.js.map